(window.webpackJsonp=window.webpackJsonp||[]).push([[170],{616:function(a,t,s){"use strict";s.r(t);var e=s(69),r=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"mongodb-のバックアップ-リストア"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-のバックアップ-リストア"}},[a._v("#")]),a._v(" MongoDB のバックアップ/リストア")]),a._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#概要"}},[a._v("概要")])]),s("li",[s("a",{attrs:{href:"#aws-s3-を利用する方法"}},[a._v("AWS S3 を利用する方法")])]),s("li",[s("a",{attrs:{href:"#google-cloud-platform-を利用する方法"}},[a._v("Google Cloud Platform を利用する方法")])])])]),s("p"),a._v(" "),s("h2",{attrs:{id:"概要"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#概要"}},[a._v("#")]),a._v(" 概要")]),a._v(" "),s("p",[a._v("この章では"),s("a",{attrs:{href:"https://github.com/weseek/mongodb-awesome-backup",target:"_blank",rel:"noopener noreferrer"}},[a._v("weseek/mongodb-awesome-backup"),s("OutboundLink")],1),a._v(" を利用したバックアップとリストアの方法を紹介します。")]),a._v(" "),s("h3",{attrs:{id:"必要なもの"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#必要なもの"}},[a._v("#")]),a._v(" 必要なもの")]),a._v(" "),s("ul",[s("li",[a._v("Docker")]),a._v(" "),s("li",[a._v("バックアップファイルをアップロードするための AWS S3 バケット\n"),s("ul",[s("li",[a._v("S3 バケットへのアクセス権を持った IAM ユーザーのアクセスキーおよびシークレットキー")])])])]),a._v(" "),s("h2",{attrs:{id:"aws-s3-を利用する方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aws-s3-を利用する方法"}},[a._v("#")]),a._v(" AWS S3 を利用する方法")]),a._v(" "),s("h3",{attrs:{id:"事前作業"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事前作業"}},[a._v("#")]),a._v(" 事前作業")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/weseek/mongodb-awesome-backup",target:"_blank",rel:"noopener noreferrer"}},[a._v("weseek/mongodb-awesome-backup"),s("OutboundLink")],1),a._v(" は、シェルスクリプトを実行するテンポラリなコンテナを作成してバックアップ/リストアを行います。\nただし、そのコンテナ内から MongoDB サーバーへ疎通できるように、以下に示す docker コマンドオプションを追加する必要があります。")]),a._v(" "),s("h4",{attrs:{id:"mongodb-が-docker-コンテナで動作している場合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-が-docker-コンテナで動作している場合"}},[a._v("#")]),a._v(" MongoDB が docker コンテナで動作している場合")]),a._v(" "),s("p",[a._v("コンテナ名を調べる下記コマンドを実行し、コンテナ名("),s("code",[a._v("${container}")]),a._v(")を使って"),s("code",[a._v("--link ${container}:mongo")]),a._v(" オプションを追加してください。")]),a._v(" "),s("h5",{attrs:{id:"e-g"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#e-g"}},[a._v("#")]),a._v(" e.g.")]),a._v(" "),s("p",[s("code",[a._v("docker ps")]),a._v(" コマンドでコンテナ名を調べます。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("vagrant@ubuntu-xenial:/etc/docker-compose$ "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ps")]),a._v("\nCONTAINER ID        IMAGE                           COMMAND                  CREATED             STATUS                   PORTS               NAMES\n21a10f879cba        mongo                           "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"docker-entrypoint.s…"')]),a._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("11")]),a._v(" minutes ago      Up "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("11")]),a._v(" minutes            "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("27017")]),a._v("/tcp           serene_swartz\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("man")]),a._v("\n")])])]),s("p",[a._v("上記コマンドの結果、コンテナ名は "),s("code",[a._v("serene_swartzman")]),a._v(" と分かるので、追加するオプションは "),s("code",[a._v("--link serene_swartz:mongo")]),a._v(" となります。")]),a._v(" "),s("h4",{attrs:{id:"mongodb-が-docker-コンテナ以外で動作している場合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-が-docker-コンテナ以外で動作している場合"}},[a._v("#")]),a._v(" MongoDB が docker コンテナ以外で動作している場合")]),a._v(" "),s("h5",{attrs:{id:"docker-ホストの-os-が-linux-の場合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-ホストの-os-が-linux-の場合"}},[a._v("#")]),a._v(" Docker ホストの OS が Linux の場合")]),a._v(" "),s("p",[s("code",[a._v("--network host")]),a._v(" オプションを追加することで、ホストと同一のネットワークを利用できます。")]),a._v(" "),s("h5",{attrs:{id:"docker-for-mac-の場合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-for-mac-の場合"}},[a._v("#")]),a._v(" Docker for Mac の場合")]),a._v(" "),s("ul",[s("li",[a._v("(TBD: 執筆者募集)")])]),a._v(" "),s("h5",{attrs:{id:"docker-for-windows-の場合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-for-windows-の場合"}},[a._v("#")]),a._v(" Docker for Windows の場合")]),a._v(" "),s("ul",[s("li",[a._v("(TBD: 執筆者募集)")])]),a._v(" "),s("h3",{attrs:{id:"バックアップ手順"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#バックアップ手順"}},[a._v("#")]),a._v(" バックアップ手順")]),a._v(" "),s("ol",[s("li",[s("p",[s("a",{attrs:{href:"https://github.com/weseek/mongodb-awesome-backup",target:"_blank",rel:"noopener noreferrer"}},[a._v("weseek/mongodb-awesome-backup"),s("OutboundLink")],1),a._v(" コンテナを、クリーンアップオプション("),s("code",[a._v("--rm")]),a._v(")付きで実行します")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MONGODB_HOST")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("Target MongoDB Host"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_ACCESS_KEY_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("Your IAM Access Key ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_SECRET_ACCESS_KEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("Your IAM Secret Access Key"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("S3_TARGET_BUCKET_URL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("Target S3 Bucket URL "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("s3://"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v("."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  weseek/mongodb-awesome-backup\n")])])])]),a._v(" "),s("li",[s("p",[a._v("対象となる MongoDB サーバーの全てのデータベースのデータを取得し、 "),s("code",[a._v("backup-YYYYMMdd.tar.bz2")]),a._v("として指定された S3 バケットにアップロードされます")])])]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("TIP")]),a._v(" "),s("p",[a._v("その他のオプションは "),s("a",{attrs:{href:"https://github.com/weseek/mongodb-awesome-backup",target:"_blank",rel:"noopener noreferrer"}},[a._v("weseek/mongodb-awesome-backup"),s("OutboundLink")],1),a._v(" を参照してください")])]),a._v(" "),s("h3",{attrs:{id:"リストア手順"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#リストア手順"}},[a._v("#")]),a._v(" リストア手順")]),a._v(" "),s("ol",[s("li",[s("p",[s("a",{attrs:{href:"https://github.com/weseek/mongodb-awesome-backup",target:"_blank",rel:"noopener noreferrer"}},[a._v("weseek/mongodb-awesome-backup"),s("OutboundLink")],1),a._v(" コンテナを、クリーンアップオプション("),s("code",[a._v("--rm")]),a._v(")付きで実行します")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MONGODB_HOST")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("Target MongoDB Host"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_ACCESS_KEY_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("Your IAM Access Key ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_SECRET_ACCESS_KEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("Your IAM Secret Access Key"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("S3_TARGET_BUCKET_URL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("Target S3 Bucket URL "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("s3://"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v("."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("S3_TARGET_FILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backup-YYYYMMdd.tar.bz2 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  weseek/mongodb-awesome-backup restore\n")])])])]),a._v(" "),s("li",[s("p",[a._v("指定された S3 バケット配下にある指定ファイル(上記例では "),s("code",[a._v("backup-YYYYMMdd.tar.bz2")]),a._v(" )がリストアされます")])]),a._v(" "),s("li",[s("p",[a._v("GROWI を再起動してください")])])]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("TIP")]),a._v(" "),s("p",[a._v("その他のオプションは "),s("a",{attrs:{href:"https://github.com/weseek/mongodb-awesome-backup",target:"_blank",rel:"noopener noreferrer"}},[a._v("weseek/mongodb-awesome-backup"),s("OutboundLink")],1),a._v(" を参照してください")])]),a._v(" "),s("h2",{attrs:{id:"google-cloud-platform-を利用する方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#google-cloud-platform-を利用する方法"}},[a._v("#")]),a._v(" Google Cloud Platform を利用する方法")]),a._v(" "),s("ul",[s("li",[a._v("(TBD: 執筆者募集)")])])])}),[],!1,null,null,null);t.default=r.exports}}]);