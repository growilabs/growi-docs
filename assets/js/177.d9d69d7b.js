(window.webpackJsonp=window.webpackJsonp||[]).push([[177],{624:function(s,a,t){"use strict";t.r(a);var n=t(69),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"v5-0-系から-v4-5-系以下へのダウングレード"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#v5-0-系から-v4-5-系以下へのダウングレード"}},[s._v("#")]),s._v(" v5.0 系から v4.5 系以下へのダウングレード")]),s._v(" "),t("p",[s._v("v5.0 にアップグレードしたシステムを v4.5 系以下にダウングレードする場合は、v4.5 系に切り替えて起動する前に MongoDB スキーマの migrate down を行う必要があります。"),t("br"),s._v("\n以下の手順を実施してください。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("ダウングレードは、オンプレミス または "),t("a",{attrs:{href:"https://github.com/growilabs/growi-docker-compose",target:"_blank",rel:"noopener noreferrer"}},[s._v("growilabs/growi-docker-compose"),t("OutboundLink")],1),s._v(" で運用中のシステムで可能です。"),t("br"),s._v("\nそれ以外の形態で運用中のシステムに関してはダウングレードはサポートしておりません。ご了承ください。")])]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),t("p",[s._v("ダウングレードでは、データ破損の可能性はありませんが、page collection のページパスのデータの不整合が発生するなどのリスクがゼロではありません。"),t("br"),s._v("\n管理者による自己責任で操作をお願いします。")])]),s._v(" "),t("h2",{attrs:{id:"手順"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#手順"}},[s._v("#")]),s._v(" 手順")]),s._v(" "),t("h3",{attrs:{id:"本番用ローカルリポジトリを使って作業するパターン"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#本番用ローカルリポジトリを使って作業するパターン"}},[s._v("#")]),s._v(" 本番用ローカルリポジトリを使って作業するパターン")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("本番のサーバーを停止する")]),s._v(" "),t("ul",[t("li",[s._v("MongoDB は起動したままにする")])])]),s._v(" "),t("li",[t("p",[s._v("v5.0.0 のシステムを利用可能な状態のまま以下の手順を実施する")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("growi-docker-compose を利用している場合は bash プロセスを起動")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker-compose")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--rm")]),s._v(" app "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n")])])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("packages/app")]),s._v(" ディレクトリ下で "),t("code",[s._v("migrate-mongo down")]),s._v(" コマンドを実行")]),s._v(" "),t("ul",[t("li",[s._v("ターミナルの出力に "),t("code",[s._v("MIGRATED DOWN: 20211227060705-revision-path-to-page-id-schema-migration.js")]),s._v(" が出現するまで複数回実行する")]),s._v(" "),t("li",[s._v("参考: v5.0.0 から v4.5.15 へのダウングレードでは 3 回の "),t("code",[s._v("migrate-mongo down")]),s._v(" 実行が必要です")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1回目 (20220311011114-convert-page-delete-config)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NODE_ENV")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("production "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" dotenv-flow/config node_modules/.bin/migrate-mongo down\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2回目 (20220131001218-convert-redirect-to-pages-to-page-redirect-documents)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NODE_ENV")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("production "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" dotenv-flow/config node_modules/.bin/migrate-mongo down\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3回目 (20211227060705-revision-path-to-page-id-schema-migration)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NODE_ENV")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("production "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" dotenv-flow/config node_modules/.bin/migrate-mongo down\n")])])])])])]),s._v(" "),t("li",[t("p",[s._v("v4.5 系のシステムを利用可能な状態に切り替えてクライアントビルド、サーバー起動")])])]),s._v(" "),t("h3",{attrs:{id:"作業用リポジトリを-clone-するパターン"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#作業用リポジトリを-clone-するパターン"}},[s._v("#")]),s._v(" 作業用リポジトリを clone するパターン")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("本番のサーバーを停止する")]),s._v(" "),t("ul",[t("li",[s._v("MongoDB は起動したままにする")])])]),s._v(" "),t("li",[t("p",[s._v("運用中の MongoDB にアクセスできる環境でリポジトリを clone")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/growilabs/growi "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-b")]),s._v(" v5.0.0 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--depth")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 依存ライブラリの取得")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" lerna bootstrap\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" packages/app\n")])])])]),s._v(" "),t("li",[t("p",[t("code",[s._v(".env.local")]),s._v(" の作成")]),s._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("MIGRATIONS_DIR")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("src/migrations/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 環境に合わせて変更してください")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("MONGO_URI")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v('"mongodb://${mongodbhost}:27017/growi"')]),s._v("\n")])])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("migrate-mongo down")]),s._v(" コマンドを実行")]),s._v(" "),t("ul",[t("li",[s._v("ターミナルの出力に "),t("code",[s._v("MIGRATED DOWN: 20211227060705-revision-path-to-page-id-schema-migration.js")]),s._v(" が出現するまで複数回実行する")]),s._v(" "),t("li",[s._v("参考: v5.0.0 から v4.5.15 へのダウングレードでは 3 回の "),t("code",[s._v("migrate-mongo down")]),s._v(" 実行が必要です")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1回目 (20220311011114-convert-page-delete-config)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" ts-node node_modules/.bin/migrate-mongo down\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2回目 (20220131001218-convert-redirect-to-pages-to-page-redirect-documents)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" ts-node node_modules/.bin/migrate-mongo down\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3回目 (20211227060705-revision-path-to-page-id-schema-migration)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" ts-node node_modules/.bin/migrate-mongo down\n")])])])]),s._v(" "),t("li",[t("p",[s._v("作業用リポジトリの削除")])]),s._v(" "),t("li",[t("p",[s._v("本番環境で v4.5 系のタグをチェックアウト")])]),s._v(" "),t("li",[t("p",[s._v("クライアントビルド、サーバー起動")])])]),s._v(" "),t("h2",{attrs:{id:"出力例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#出力例"}},[s._v("#")]),s._v(" 出力例")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" ➜ /workspace/growi/packages/app "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" $ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" ts-node node_modules/.bin/migrate-mongo down\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run v1.22.17\n$ ts-node "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" tsconfig-paths/register "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"growi:migrate:convert-page-delete-config"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hostname"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxxxxxxxx"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pid"')]),s._v(":1111,"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"level"')]),s._v(":30,"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Migration down has successfully applied"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-03-31T05:54:22.448Z"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v"')]),s._v(":0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nMIGRATED DOWN: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20220311011114")]),s._v("-convert-page-delete-config.js\nDone "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".71s.\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" ➜ /workspace/growi/packages/app "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" $ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" ts-node node_modules/.bin/migrate-mongo down\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run v1.22.17\n$ ts-node "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" tsconfig-paths/register "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"growi:migrate:convert-redirect-to-pages-to-page-redirect-documents"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hostname"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxxxxxxxx"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pid"')]),s._v(":1111,"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"level"')]),s._v(":30,"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Migration down has successfully applied"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-03-31T05:54:27.944Z"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v"')]),s._v(":0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nMIGRATED DOWN: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20220131001218")]),s._v("-convert-redirect-to-pages-to-page-redirect-documents.js\nDone "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".42s.\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" ➜ /workspace/growi/packages/app "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" $ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" ts-node node_modules/.bin/migrate-mongo down\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run v1.22.17\n$ ts-node "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" tsconfig-paths/register "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"growi:migrate:revision-path-to-page-id-schema-migration"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hostname"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxxxxxxxx"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pid"')]),s._v(":1111,"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"level"')]),s._v(":30,"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Migration down has successfully applied"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-03-31T05:54:31.169Z"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v"')]),s._v(":0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nMIGRATED DOWN: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20211227060705")]),s._v("-revision-path-to-page-id-schema-migration.js\nDone "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".99s.\n")])])]),t("h2",{attrs:{id:"トラブルシュート"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#トラブルシュート"}},[s._v("#")]),s._v(" トラブルシュート")]),s._v(" "),t("h3",{attrs:{id:"error-an-env-var-migrations-dir-must-be-set-error-an-env-var-migrations-dir-must-be-set"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#error-an-env-var-migrations-dir-must-be-set-error-an-env-var-migrations-dir-must-be-set"}},[s._v("#")]),s._v(" "),t("code",[s._v("ERROR: An env var MIGRATIONS_DIR must be set. Error: An env var MIGRATIONS_DIR must be set.")])]),s._v(" "),t("p",[s._v("一時的に環境変数を設定する "),t("code",[s._v(".env.local")]),s._v(" を作成し、"),t("code",[s._v("MIGRATIONS_DIR")]),s._v(" を設定してください。")]),s._v(" "),t("p",[s._v("本番用ローカルリポジトリを使って作業するパターンでは Node.js プロセスで実行可能な "),t("code",[s._v("MIGRATIONS_DIR=dist/migrations/")]),s._v(" を指定します。")]),s._v(" "),t("p",[s._v("作業用リポジトリを clone するパターンでは ts-node プロセスで実行可能な "),t("code",[s._v("MIGRATIONS_DIR=src/migrations/")]),s._v(" を指定します。")])])}),[],!1,null,null,null);a.default=e.exports}}]);