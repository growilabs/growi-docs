(window.webpackJsonp=window.webpackJsonp||[]).push([[162],{608:function(a,t,s){"use strict";s.r(t);var _=s(69),r=Object(_.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"custom-rate-limitの設定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#custom-rate-limitの設定"}},[a._v("#")]),a._v(" Custom rate limitの設定")]),a._v(" "),s("p",[a._v("GROWIでのAPIのrate limitについて紹介します。")]),a._v(" "),s("h2",{attrs:{id:"概要"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#概要"}},[a._v("#")]),a._v(" 概要")]),a._v(" "),s("p",[a._v("エンドポイント毎、ユーザー(ゲストユーザーの場合はIP)毎にレート制限ウィンドウ(秒)あたりの、最大リクエスト数を設定できます。\nレート制限ウィンドウは60秒で固定の値になっています。\nレート制限ウィンドウ内に同一ユーザーにより最大リクエスト数を超える回数のリクエストがあった場合は "),s("code",[a._v("419 too many requests")]),a._v(" のエラーを返します。")]),a._v(" "),s("h3",{attrs:{id:"ログイン済みユーザーの場合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ログイン済みユーザーの場合"}},[a._v("#")]),a._v(" ログイン済みユーザーの場合")]),a._v(" "),s("p",[a._v("ログイン済みユーザーの場合、制限をかけるためのkeyは"),s("strong",[a._v("エンドポイント")]),a._v("と"),s("strong",[a._v("リクエストメソッド")]),a._v("と"),s("strong",[a._v("ユーザーID")]),a._v("を含めた文字列のハッシュ値になります。同じIPアドレスからのリクエストもユーザーごとに区別できます。")]),a._v(" "),s("h3",{attrs:{id:"未ログインユーザーの場合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#未ログインユーザーの場合"}},[a._v("#")]),a._v(" 未ログインユーザーの場合")]),a._v(" "),s("p",[a._v("未ログインユーザーの場合、制限をかけるためのkeyは"),s("strong",[a._v("エンドポイント")]),a._v("と"),s("strong",[a._v("リクエストメソッド")]),a._v("と"),s("strong",[a._v("IPアドレス")]),a._v("を含めた文字列のハッシュ値になります。この時、最大リクエスト数には、1IPアドレス当たりの想定人数をかけた値が利用されます。1IPアドレス当たりの想定人数は、デフォルトでは5人/ipとなっています。1IPアドレス当たりの想定人数は、環境変数を用いてエンドポイントとメソッドごとにカスタマイズできます。")]),a._v(" "),s("h2",{attrs:{id:"デフォルトの設定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#デフォルトの設定"}},[a._v("#")]),a._v(" デフォルトの設定")]),a._v(" "),s("p",[a._v("エンドポイントにはデフォルトで下の表の制限がかけられています。")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("時間(秒)")]),a._v(" "),s("th",[a._v("最大リクエスト数(回)")]),a._v(" "),s("th",[a._v("IPアドレス当たりの想定人数")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("60")]),a._v(" "),s("td",[a._v("500")]),a._v(" "),s("td",[a._v("5")])])])]),a._v(" "),s("h3",{attrs:{id:"初期値がカスタマイズされているエンドポイント"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#初期値がカスタマイズされているエンドポイント"}},[a._v("#")]),a._v(" 初期値がカスタマイズされているエンドポイント")]),a._v(" "),s("p",[a._v("その他、制限が必要なエンドポイントには以下の設定ファイルによって、デフォルトでカスタマイズされた初期値が制限として設定されています。")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/growilabs/growi/blob/master/packages/app/config/rate-limiter.ts",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://github.com/growilabs/growi/blob/master/packages/app/config/rate-limiter.ts"),s("OutboundLink")],1)]),a._v(" "),s("h2",{attrs:{id:"制限のカスタマイズ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#制限のカスタマイズ"}},[a._v("#")]),a._v(" 制限のカスタマイズ")]),a._v(" "),s("p",[a._v("デフォルトの制限を上書きして、カスタイマイズするためには環境変数を用いて設定します。")]),a._v(" "),s("h3",{attrs:{id:"設定例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#設定例"}},[a._v("#")]),a._v(" 設定例")]),a._v(" "),s("p",[a._v("環境変数で設定する項目は以下の4つです。")]),a._v(" "),s("ul",[s("li",[a._v("エンドポイント(必須)")]),a._v(" "),s("li",[a._v("リクエストメソッド")]),a._v(" "),s("li",[a._v("レート制限ウィンドウ当たりの最大リクエスト数(必須)")]),a._v(" "),s("li",[a._v("1IPアドレス当たりの想定人数")])]),a._v(" "),s("p",[a._v("下のように環境変数を設定できます。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("API_RATE_LIMIT_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("KEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("_ENDPOINT"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/_api/v3/foo // エンドポイント\nAPI_RATE_LIMIT_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("KEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("_METHODS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("GET,POST // リクエストメソッド\nAPI_RATE_LIMIT_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("KEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("_MAX_REQUESTS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v(" // レート制限ウィンドウ内の最大リクエスト数\nAPI_RATE_LIMIT_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("KEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("_USERS_PER_IP"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" // 1IPアドレス当たりの想定人数\n")])])]),s("p",[a._v("リクエストメソッドの以外の設定は任意です。設定されていない場合、そのエンドポイントに対するすべてのメソッドに対して制限がかけられます。1IPアドレス当たりの想定人数は、設定されていない場合はデフォルト値の5が設定されます。")]),a._v(" "),s("p",[s("code",[a._v("[key]")]),a._v("の部分は任意の文字列です。ただし、同じエンドポイントに対して制限が設定されていた場合、"),s("code",[a._v("[key]")]),a._v("の部分をin-placeアルゴリズム(JavaScriptのsort()メソッド)でソートしたときに、後に来るkeyの設定を優先します。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("API_RATE_LIMIT_010_FOO_ENDPOINT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/_api/v3/foo\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("API_RATE_LIMIT_010_FOO_METHODS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("GET,POST\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("API_RATE_LIMIT_010_FOO_MAX_REQUESTS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("API_RATE_LIMIT_010_FOO_USERS_PER_IP")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n")])])]),s("p",[a._v("このように環境変数を設定すると、以下のように制限が適用されます。")]),a._v(" "),s("ul",[s("li",[a._v("ログイン済みユーザーの場合")])]),a._v(" "),s("p",[s("code",[a._v("/_api/v3/foo")]),a._v("というエンドポイントに対して、"),s("code",[a._v("GET")]),a._v(" "),s("code",[a._v("POST")]),a._v("のリクエストを60秒間に11回以上送ると11回目以降はエラーが発生しリクエストを送ることができなくなります。60秒が経過すると、再びリクエストを送ることができるようになります。")]),a._v(" "),s("ul",[s("li",[a._v("未ログインユーザーの場合")])]),a._v(" "),s("p",[s("code",[a._v("/_api/v3/foo")]),a._v("というエンドポイントに対して、"),s("code",[a._v("GET")]),a._v(" "),s("code",[a._v("POST")]),a._v("のリクエストを同一IPアドレスから21回以上送ると、21回目以降はエラーが発生しリクエストを送ることができなくなります。60秒が経過すると、再びリクエストを送ることができるようになります。")]),a._v(" "),s("h3",{attrs:{id:"正規表現を用いた環境変数のカスタマイズ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#正規表現を用いた環境変数のカスタマイズ"}},[a._v("#")]),a._v(" 正規表現を用いた環境変数のカスタマイズ")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("GET "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'/62df87c8539c3090b8cc7621'")]),a._v(" // ページの閲覧\nGET "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'/share/62e2256f19e932f82eebe830'")]),a._v(" // 共有ページの閲覧\n")])])]),s("p",[a._v("上のような、可変的なエンドポイントの制限は正規表現と環境変数を用いて制限をカスタマイズできます。")]),a._v(" "),s("h3",{attrs:{id:"設定例-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#設定例-2"}},[a._v("#")]),a._v(" 設定例")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("API_RATE_LIMIT_010_SHARE_ENDPOINT_WITH_REGEXP")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/share/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("-9a-z"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("24")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("API_RATE_LIMIT_010_SHARE_METHODS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("GET\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("API_RATE_LIMIT_010_SHARE_MAX_REQUESTS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("20")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("API_RATE_LIMIT_010_SHARE_USERS_PER_IP")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);