(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{491:function(t,s,a){"use strict";a.r(s);var e=a(69),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"downgrading-from-v5-0-to-v4-5-or-lower"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#downgrading-from-v5-0-to-v4-5-or-lower"}},[t._v("#")]),t._v(" Downgrading from v5.0 to v4.5 or lower")]),t._v(" "),a("p",[t._v("If you want to downgrade from v5.0 to v4.5 or lower, you need to migrate down the MongoDB schema before switching to v4.5 and booting.\nPlease follow the steps below.")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("Downgrading is availble for systems running on-premise or running with "),a("a",{attrs:{href:"https://github.com/growilabs/growi-docker-compose",target:"_blank",rel:"noopener noreferrer"}},[t._v("growilabs/growi-docker-compose"),a("OutboundLink")],1),t._v(".\nPlease note that downgrading is not supported for other forms of system operations.")])]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),a("p",[t._v("Downgrading does not have the potential for data corruption, but there is a risk of data inconsistencies in the page's path.\nPlease undertake it at your own risk as an administrator.")])]),t._v(" "),a("h2",{attrs:{id:"procedure"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#procedure"}},[t._v("#")]),t._v(" Procedure")]),t._v(" "),a("h3",{attrs:{id:"work-patterns-with-a-local-repository-that-is-meant-for-production"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#work-patterns-with-a-local-repository-that-is-meant-for-production"}},[t._v("#")]),t._v(" Work Patterns with a Local Repository that is Meant for Production")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("Stop the production server")]),t._v(" "),a("ul",[a("li",[t._v("Keep MongoDB running")])])]),t._v(" "),a("li",[a("p",[t._v("Perform following steps while keeping the v5.0.0 system available")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("Start the bash process if you are using growi-docker-compose")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker-compose")]),t._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--rm")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("Run "),a("code",[t._v("migrate-mongo down")]),t._v(" command in the "),a("code",[t._v("packages/app")]),t._v(" directory")]),t._v(" "),a("ul",[a("li",[t._v("Run multiple times until "),a("code",[t._v("MIGRATED DOWN: 20211227060705-revision-path-to-page-id-schema-migration.js")]),t._v(" appears in the terminal output.")]),t._v(" "),a("li",[t._v("Note: downgrading from v5.0.0 to v4.5.15 requires  "),a("code",[t._v("migrate-mongo down")]),t._v(" to be run 3 times.")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1st time (20220311011114-convert-page-delete-config)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("NODE_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("production "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" dotenv-flow/config node_modules/.bin/migrate-mongo down\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2nd time (20220131001218-convert-redirect-to-pages-to-page-redirect-documents)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("NODE_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("production "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" dotenv-flow/config node_modules/.bin/migrate-mongo down\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3rd time (20211227060705-revision-path-to-page-id-schema-migration)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("NODE_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("production "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" dotenv-flow/config node_modules/.bin/migrate-mongo down\n")])])])])])]),t._v(" "),a("li",[a("p",[t._v("Switch the v4.5 system to the available state, build the client, then start the server")])])]),t._v(" "),a("h3",{attrs:{id:"patterns-for-cloning-working-repository"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#patterns-for-cloning-working-repository"}},[t._v("#")]),t._v(" Patterns for Cloning Working Repository")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("Stop the production server")]),t._v(" "),a("ul",[a("li",[t._v("Keep MongoDB running")])])]),t._v(" "),a("li",[a("p",[t._v("Clone the repository in an environment where you can access MongoDB in production")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/growilabs/growi "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-b")]),t._v(" v5.0.0 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--depth")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Get dependent libraries")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" lerna bootstrap\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" packages/app\n")])])])]),t._v(" "),a("li",[a("p",[t._v("Create "),a("code",[t._v(".env.local")])]),t._v(" "),a("div",{staticClass:"language-properties extra-class"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("MIGRATIONS_DIR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("src/migrations/")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Please change according to your environment")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("MONGO_URI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v('"mongodb://${mongodbhost}:27017/growi"')]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("Execute "),a("code",[t._v("migrate-mongo down")]),t._v(" command")]),t._v(" "),a("ul",[a("li",[t._v("Run multiple times until "),a("code",[t._v("MIGRATED DOWN: 20211227060705-revision-path-to-page-id-schema-migration.js")]),t._v(" appears in the terminal output.")]),t._v(" "),a("li",[t._v("Note: downgrading from v5.0.0 to v4.5.15 requires  "),a("code",[t._v("migrate-mongo down")]),t._v(" to be run 3 times.")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1st time (20220311011114-convert-page-delete-config)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" ts-node node_modules/.bin/migrate-mongo down\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2nd time (20220131001218-convert-redirect-to-pages-to-page-redirect-documents)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" ts-node node_modules/.bin/migrate-mongo down\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3rd time (20211227060705-revision-path-to-page-id-schema-migration)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" ts-node node_modules/.bin/migrate-mongo down\n")])])])]),t._v(" "),a("li",[a("p",[t._v("Delete working repository")])]),t._v(" "),a("li",[a("p",[t._v("Checkout v4.5 tags in production environment")])]),t._v(" "),a("li",[a("p",[t._v("Build client, then start the server")])])]),t._v(" "),a("h2",{attrs:{id:"output-example"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#output-example"}},[t._v("#")]),t._v(" Output Example")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" ➜ /workspace/growi/packages/app "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" $ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" ts-node node_modules/.bin/migrate-mongo down\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" run v1.22.17\n$ ts-node "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" tsconfig-paths/register "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"growi:migrate:convert-page-delete-config"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hostname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxxxxxx"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pid"')]),t._v(":1111,"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),t._v(":30,"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Migration down has successfully applied"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-03-31T05:54:22.448Z"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v"')]),t._v(":0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nMIGRATED DOWN: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20220311011114")]),t._v("-convert-page-delete-config.js\nDone "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".71s.\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" ➜ /workspace/growi/packages/app "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" $ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" ts-node node_modules/.bin/migrate-mongo down\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" run v1.22.17\n$ ts-node "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" tsconfig-paths/register "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"growi:migrate:convert-redirect-to-pages-to-page-redirect-documents"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hostname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxxxxxx"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pid"')]),t._v(":1111,"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),t._v(":30,"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Migration down has successfully applied"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-03-31T05:54:27.944Z"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v"')]),t._v(":0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nMIGRATED DOWN: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20220131001218")]),t._v("-convert-redirect-to-pages-to-page-redirect-documents.js\nDone "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".42s.\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" ➜ /workspace/growi/packages/app "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" $ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" ts-node node_modules/.bin/migrate-mongo down\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" run v1.22.17\n$ ts-node "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" tsconfig-paths/register "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"growi:migrate:revision-path-to-page-id-schema-migration"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hostname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxxxxxx"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pid"')]),t._v(":1111,"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),t._v(":30,"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Migration down has successfully applied"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-03-31T05:54:31.169Z"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v"')]),t._v(":0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nMIGRATED DOWN: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20211227060705")]),t._v("-revision-path-to-page-id-schema-migration.js\nDone "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".99s.\n")])])]),a("h2",{attrs:{id:"troubleshoot"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#troubleshoot"}},[t._v("#")]),t._v(" Troubleshoot")]),t._v(" "),a("h3",{attrs:{id:"error-an-env-var-migrations-dir-must-be-set-error-an-env-var-migrations-dir-must-be-set"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#error-an-env-var-migrations-dir-must-be-set-error-an-env-var-migrations-dir-must-be-set"}},[t._v("#")]),t._v(" "),a("code",[t._v("ERROR: An env var MIGRATIONS_DIR must be set. Error: An env var MIGRATIONS_DIR must be set.")])]),t._v(" "),a("p",[t._v("Create "),a("code",[t._v(".env.local")]),t._v(" to temporarily set environment variables and set"),a("code",[t._v("MIGRATIONS_DIR")]),t._v(".")]),t._v(" "),a("p",[t._v("The pattern for working with a production local repository specifies "),a("code",[t._v("MIGRATIONS_DIR=dist/migrations/")]),t._v(" that can be run with Node.js.")]),t._v(" "),a("p",[t._v("The pattern for cloning the working repository specifies "),a("code",[t._v("MIGRATIONS_DIR=src/migrations/")]),t._v(" which can be executed with ts-node.")])])}),[],!1,null,null,null);s.default=n.exports}}]);